---
import { db, Signee, Pledge, eq, count } from 'astro:db';
const { pledgeId } = Astro.props;
const signeesResult = await db.select({ value: count() }).from(Signee).where(eq(Signee.pledgeId, pledgeId));
let signees = signeesResult[0]?.value ?? 0;
// If signees is under 100, add 100 
signees = signees < 100 ? signees + 100 : signees;
const pledgeResult = await db.select().from(Pledge).where(eq(Pledge.id, pledgeId)).limit(1);
const pledge = pledgeResult[0];
let target = pledge?.target ?? 1000;
if (pledge && pledge.isMovingTarget) {
  // Set target to the nearest rounded figure at least a third above current signees
  if (target <= signees) {
    target = Math.ceil((signees * 1.33) / 1000) * 1000;
  }
}

---
<div class="flex flex-col">
  <div class="w-full max-w-sm bg-gray-200 rounded-full h-6 mb-2 relative">
    <div 
      class="bg-primary-500 h-6 rounded-full transition-all duration-500"
      style={`width: ${signees / target * 100}%;`}
      aria-valuenow={signees}
      aria-valuemax={target}
      aria-valuemin="0"
      role="progressbar"
    ></div>
  </div>
  <div class="text-4xl font-bold text-primary-600 mb-1">{signees}</div>
  <div class="text-gray-600">Help us get to {target}</div>
</div>